# 作業ログ 2026-02-12

## YouTube サムネイル 403 エラー対応
- `youtube_uploader.py` のサムネイル設定を try-except でグレースフル処理に変更
- 原因: YouTube アカウントの電話番号認証が未完了
- 対応: ユーザーが YouTube Studio で電話認証を実施、手動でサムネイル設定

## X (Twitter) 投稿の 403/401 エラー対応
- 原因: X Developer Portal のアプリ権限が Read のみだった
- 対応: Read and Write に変更 → API Key/Access Token を全再生成 → .env 更新
- 投稿成功を確認

## Gemini 読みアノテーション自動挿入の廃止
- `script_generator.py` のプロンプトから読みアノテーション指示を削除
- 今後は手動（script.json 編集 + reading_dict.txt）のみで対応

## YouTube 概要欄の改善
- `upload.py` に `_extract_intro()` を追加
- タイトル流用 → note_content の H1 直下段落 + ハッシュタグに変更

## YouTube ショート動画アップロード機能
- `src/upload_shorts.py` を新規作成
- `upload_info.json` から本編 URL を取得し、概要欄に本編リンク・タグ・チャンネルURLを記載
- タイトルの `\n` を YouTube アップロード時に除去

## テロップ改行制御
- `text_renderer.py` の `_wrap_text_by_width()` が `\n` を明示的改行として処理するよう改修
- script.json のセリフに `\n` を入れることで、句読点での改行が可能に

## 毎日の記念日メール送信機能
- `scripts/daily_kinenbi.py` を新規作成
  - Wikipedia 日本語版から「記念日・年中行事」セクションを取得
  - SendGrid API でメール送信
  - `--dry-run` / `--date` オプション対応
- `.github/workflows/daily_kinenbi.yml` を作成
  - 毎日 0:15 JST (cron: `15 15 * * *`) に自動実行
  - `workflow_dispatch` で手動実行も可能
- SendGrid アカウント設定、Sender 認証、API Key 発行を実施
- GitHub Secrets に `SENDGRID_API_KEY`, `EMAIL_TO`, `EMAIL_FROM` を登録
- ローカル送信テスト成功（2月12日の記念日 7件）

## エンディング画面の実装
- `_create_ending_clip()` を `video_composer.py` に追加（横長・縦長両対応）
- 構成: チャンネル登録誘導テキスト → 撤収雑談ボイス（字幕なし） → キャラのみフェードアウト
- キャラのみフェードアウトし、テキスト・ロゴは最後まで表示
  - `_char_opacity()`: フェードイン+フェードアウト（キャラ用）
  - `_static_opacity()`: フェードインのみ（ロゴ・テキスト用）
- 横長: キャラふわふわ浮遊（本編と同様）
- 縦長: キャラ半分サイズでブロック崩しのボールのように跳ね回る（`_bounce()` 関数）
- `scripts/generate_ending_voice.py` 新規作成（COEIROINK でボイス4種生成）
- `config.py` に ED 設定（ボイスパス、フェードイン/アウト秒数、セリフ間隔等）を追加
- EDボイスが存在しない場合はグレースフルスキップ

## Shorts アップロード修正
- `upload_shorts.py`: タイトルに `#Shorts` タグを自動付与（API 経由で Shorts として認識させるため）

## shorts_skip によるセリフ省略機能
- `DialogueLine` に `shorts_skip: bool` フィールドを追加
- `script_generator.py`: Gemini プロンプトに `shorts_skip` タグ付けの指示を追加（脱線・補足・相槌が対象、全体の20-30%）
- `compose_portrait()`: 推定尺が 3 分を超える場合のみ `shorts_skip=true` のセリフを除外
- 倍速（`with_speed_scaled()`）はフォールバックとして残存（ピッチ上昇するため非推奨）

## COEIROINK 記号のみテキスト対応
- `audio_generator.py`: 日本語/英数字を含まない記号のみテキスト（例: `…？`）で COEIROINK が 500 エラーを返す問題に対応
- 正規表現で発音可能文字の有無を判定し、なければ 0.5 秒の無音 WAV を生成

## 統合 CLI の実装
- `src/cli.py` を新規作成 — `HebodanCLI` クラス + argparse subparsers
- `src/__main__.py` を新規作成 — `python -m src <command>` で呼び出し可能に
- サブコマンド: `run`（インタラクティブ全工程）、`generate`（動画生成）、`upload`（YouTube）、`shorts`（Shorts）、`post`（X投稿）、`status`（状態表示）
- `run` コマンド: 台本生成 → 台本確認（Y/n/edit） → 音声+動画生成 → 動画確認 → YouTube → Shorts → X → サマリーの対話フロー
- `edit` 選択時は `$EDITOR` で script.json を開き、閉じた後に再読み込み
- 途中で中断しても `-s` オプションで再開可能
- `status` コマンド: 出力ディレクトリのファイル存在状況を一覧表示
- 既存モジュール最小リファクタ: `upload.py` / `upload_shorts.py` / `post_x.py` に `run_*()` 関数を追加（`main()` は後方互換で維持）
- 既存の `python -m src.main` 等は引き続き動作（後方互換）
- `manual.md` にクイックスタートセクション（コマンド体系 + run フロー）を追加

## run コマンドの「台本修正→再生成」ループ追加
- `cli.py` の動画確認プロンプトを `[Y/edit/n]` の3択に変更
  - `y`/Enter → アップロードへ進む
  - `edit` → `$EDITOR` で台本を修正し、音声＋動画を再生成（ループ）
  - `n` → 中断（`-s` で再開可能）
- 音声＋動画生成ブロックを `while True:` ループで囲み、edit 選択時に再生成できるように
- `manual.md` のインタラクティブフロー説明を更新

## run コマンドに YouTube 公開確認ステップを追加
- YouTube アップロード後・Shorts/X 投稿前に「YouTube Studio で公開設定してください」ステップを追加
- YouTube Studio URL を表示し、公開設定完了まで Enter 待機
- X 投稿プロンプトにも「非公開の場合サムネイルは展開されません」の注意書きを追加
- `manual.md` のフロー説明を更新（ステップ番号調整）

## Zenn 技術記事の作成
- `docs-dev/zenn/hebodan.md` を新規作成
- プロジェクト初期構築から現在までの技術解説記事
- 構成: 技術スタック → アーキテクチャ → 台本生成 → 音声合成 → 動画合成 → 背景画像 → キャラ画像 → 統合CLI → 開発プロセス → エラー対処
- Zenn フロントマター付き（`published: false`）
